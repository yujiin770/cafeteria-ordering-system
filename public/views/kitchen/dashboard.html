<!DOCTYPE html>
<html>
<head>
    <title>üç≥ Kitchen Dashboard - Cafeteria System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .order-card {
            transition: all 0.25s ease;
            border-left: 6px solid #ffc107;
        }
        .order-pending { border-left-color: #ffc107; }
        .order-preparing { border-left-color: #0dcaf0; }
        .order-completed {
            border-left-color: #198754;
            opacity: 0.75;
        }
    </style>
</head>


<body class="bg-light">
<div class="container-fluid p-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-primary">üç≥ Kitchen Dashboard</h1>
            <p class="text-muted mb-0">Live order tracking</p>
        </div>
        <a href="/" class="btn btn-outline-secondary">Logout</a>
    </div>

    <!-- Stats -->
    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div class="card bg-warning bg-opacity-10">
                <div class="card-body">
                    <h2 id="pending-count">0</h2>
                    <small>Pending</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info bg-opacity-10">
                <div class="card-body">
                    <h2 id="preparing-count">0</h2>
                    <small>Preparing</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success bg-opacity-10">
                <div class="card-body">
                    <h2 id="completed-count">0</h2>
                    <small>Completed</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders -->
    <div class="row" id="orders-container">
        <div class="col-12 text-center text-muted p-5">
            Waiting for orders...
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let orders = [];

/* üîå CONNECT */
socket.on('connect', () => {
    console.log('‚úÖ Kitchen connected');
    socket.emit('joinRoom', 'kitchen');
});

/* üì• NEW ORDER */
socket.on('newOrder', (order) => {
    order.items = typeof order.items === 'string'
        ? JSON.parse(order.items)
        : order.items;

    orders.unshift(order);
    renderOrders();
});

/* üîÑ STATUS UPDATE */
socket.on('orderStatusUpdate', (data) => {
    const order = orders.find(o => o.orderNumber === data.orderNumber);
    if (order) {
        order.status = data.status;
        renderOrders();
    }
});

/* üß† RENDER */
function renderOrders() {
    const container = document.getElementById('orders-container');

    if (orders.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center text-muted p-5">
                No active orders
            </div>`;
        updateCounts();
        return;
    }

    container.innerHTML = orders.map(order => `
        <div class="col-md-4 mb-4">
            <div class="card order-card order-${order.status}">
                <div class="card-body">
                    <h5 class="fw-bold">${order.orderNumber}</h5>
                    <ul class="list-group mb-3">
                        ${order.items.map(i => `
                            <li class="list-group-item d-flex justify-content-between">
                                ${i.name}
                                <span>x${i.quantity}</span>
                            </li>
                        `).join('')}
                    </ul>

                    <div class="d-flex justify-content-between">
                        <span class="badge bg-secondary">${order.status}</span>

                        ${order.status === 'pending'
                            ? `<button class="btn btn-sm btn-info"
                                onclick="updateStatus('${order.orderNumber}','preparing')">
                                Prepare
                               </button>`
                            : order.status === 'preparing'
                            ? `<button class="btn btn-sm btn-success"
                                onclick="updateStatus('${order.orderNumber}','completed')">
                                Complete
                               </button>`
                            : ''
                        }
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    updateCounts();
}

/* üî¢ COUNTS */
function updateCounts() {
    const counts = { pending: 0, preparing: 0, completed: 0 };

    orders.forEach(o => counts[o.status]++);

    document.getElementById('pending-count').textContent = counts.pending;
    document.getElementById('preparing-count').textContent = counts.preparing;
    document.getElementById('completed-count').textContent = counts.completed;
}

/* üîß UPDATE STATUS */
function updateStatus(orderNumber, status) {
    socket.emit('updateOrderStatus', { orderNumber, status });
}
</script>
</body>
</html>
