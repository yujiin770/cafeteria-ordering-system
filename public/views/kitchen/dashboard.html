<!DOCTYPE html>
<html>
<head>
    <title>üç≥ Kitchen Dashboard - Cafeteria System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-pending { border-left: 5px solid #ffc107 !important; }
        .order-preparing { border-left: 5px solid #17a2b8 !important; }
        .order-completed { border-left: 5px solid #28a745 !important; opacity: 0.7; }
        .kitchen-container { max-width: 1400px; margin: 0 auto; }
        .order-card { transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important; }
    </style>
</head>
<body class="bg-light">
    <div class="kitchen-container p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-5 fw-bold text-primary">üç≥ Kitchen Dashboard</h1>
                <p class="text-muted">Real-time order management</p>
            </div>
            <a href="/" class="btn btn-outline-secondary btn-lg">üö™ Logout</a>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-warning bg-opacity-10">
                    <div class="card-body">
                        <h3 id="pending-count" class="text-warning">0</h3>
                        <small>Pending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info bg-opacity-10">
                    <div class="card-body">
                        <h3 id="preparing-count" class="text-info">0</h3>
                        <small>Preparing</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success bg-opacity-10">
                    <div class="card-body">
                        <h3 id="completed-count" class="text-success">0</h3>
                        <small>Completed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders -->
        <div class="row" id="orders-container">
            <div class="col-12 text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Waiting for orders...</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let orders = [];
        let orderCounts = { pending: 0, preparing: 0, completed: 0 };

        // Connect to kitchen room
        socket.emit('joinRoom', 'kitchen');
        console.log('üî• Kitchen connected to server');

        // Listen for new orders
        socket.on('newOrder', (order) => {
            console.log('üçΩÔ∏è New order received:', order.orderNumber);
            addOrder(order);
        });

        // Listen for status updates
        socket.on('orderStatusUpdate', (data) => {
            console.log('üîÑ Status update:', data);
            updateOrderStatus(data.orderNumber, data.status);
        });

        // Add order to display
        function addOrder(order) {
            // Parse items if it's a JSON string from DB
            const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
            
            orders.unshift({
                ...order,
                items: items,
                id: order.id || Date.now() // Fallback ID
            });
            
            updateDisplay();
            updateCounts();
        }

        // Update order status
        function updateOrderStatus(orderNumber, status) {
            const order = orders.find(o => o.orderNumber === orderNumber);
            if (order) {
                order.status = status;
                updateDisplay();
                updateCounts();
            }
        }

        // Update full display
        function updateDisplay() {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center p-5">
                        <div class="display-4 text-muted">üéâ</div>
                        <h4 class="text-muted mt-3">No orders yet!</h4>
                        <p class="text-muted">Ready for incoming orders...</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = orders.map(order => {
                const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
                const totalItems = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                
                return `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card order-card h-100 ${order.status}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="h5 mb-0">#${order.orderNumber}</strong>
                                    <br><small class="text-muted">${new Date(order.timestamp).toLocaleString()}</small>
                                </div>
                                <span class="badge fs-6 ${
                                    order.status === 'pending' ? 'bg-warning' : 
                                    order.status === 'preparing' ? 'bg-info' : 'bg-success'
                                }">${order.status.toUpperCase()}</span>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    ${items.map(item => `
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>${item.name} √ó${item.quantity || 1}</span>
                                            <span>$${item.price.toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold fs-5">
                                        <span>Total:</span>
                                        <span>$${parseFloat(order.total).toFixed(2)}</span>
                                    </div>
                                </div>
                                
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-warning w-100 mb-2" onclick="updateStatus('${order.orderNumber}', 'preparing')">
                                        üë®‚Äçüç≥ Start Preparing
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'preparing' ? `
                                    <button class="btn btn-success w-100" onclick="updateStatus('${order.orderNumber}', 'completed')">
                                        ‚úÖ Mark as Completed
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update status counts
        function updateCounts() {
            orderCounts = orders.reduce((counts, order) => {
                counts[order.status]++;
                return counts;
            }, { pending: 0, preparing: 0, completed: 0 });
            
            document.getElementById('pending-count').textContent = orderCounts.pending;
            document.getElementById('preparing-count').textContent = orderCounts.preparing;
            document.getElementById('completed-count').textContent = orderCounts.completed;
        }

        // Update status function (global for onclick)
        function updateStatus(orderNumber, status) {
            console.log(`üîß Updating ${orderNumber} to ${status}`);
            socket.emit('updateOrderStatus', { orderNumber, status });
        }

        // Connection status
        socket.on('connect', () => {
            console.log('‚úÖ Socket connected!');
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Socket disconnected!');
        });
    </script>
</body>
</html>
