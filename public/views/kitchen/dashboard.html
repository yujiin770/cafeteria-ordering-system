<!DOCTYPE html>
<html>
<head>
    <title>ğŸ³ Kitchen Dashboard - Cafeteria System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .order-pending { border-left: 5px solid #ffc107 !important; }
        .order-preparing { border-left: 5px solid #17a2b8 !important; }
        .order-completed { border-left: 5px solid #28a745 !important; opacity: 0.7; }
        .kitchen-container { max-width: 1400px; margin: 0 auto; }
        .order-card { transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important; }
    </style>
</head>
<body class="bg-light">
    <div class="kitchen-container p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-5 fw-bold text-primary">ğŸ³ Kitchen Dashboard</h1>
                <p class="text-muted">Real-time order management</p>
            </div>
            <a href="/" class="btn btn-outline-secondary btn-lg">ğŸšª Logout</a>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-warning bg-opacity-10">
                    <div class="card-body">
                        <h3 id="pending-count" class="text-warning">0</h3>
                        <small>Pending</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info bg-opacity-10">
                    <div class="card-body">
                        <h3 id="preparing-count" class="text-info">0</h3>
                        <small>Preparing</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success bg-opacity-10">
                    <div class="card-body">
                        <h3 id="completed-count" class="text-success">0</h3>
                        <small>Completed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders -->
        <div class="row" id="orders-container">
            <div class="col-12 text-center p-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Waiting for orders...</p>
            </div>
        </div>
    </div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let orders = [];
    let orderCounts = { pending: 0, preparing: 0, completed: 0 };

    // ğŸ”¥ CRITICAL: Wait for connection BEFORE joining room
    socket.on('connect', () => {
        console.log('âœ… Kitchen CONNECTED');
        // Join kitchen room AFTER connection
        socket.emit('joinRoom', 'kitchen');
        console.log('ğŸ”¥ Kitchen joined room');
    });

    // ğŸ”¥ DEBUG: See ALL events
    socket.onAny((event, ...args) => {
        console.log('ğŸ“¡ Kitchen received event:', event, args);
    });

    socket.on('newOrder', (order) => {
        console.log('ğŸ½ï¸ NEW ORDER:', order.orderNumber);
        addOrder(order);
    });

    socket.on('orderStatusUpdate', (data) => {
        console.log('ğŸ”„ Status update:', data);
        updateOrderStatus(data.orderNumber, data.status);
    });

    // ğŸ”¥ Remove loading spinner after 3 seconds
    setTimeout(() => {
        const container = document.getElementById('orders-container');
        container.innerHTML = `
            <div class="col-12 text-center p-5">
                <div class="display-4 text-success">ğŸ‰</div>
                <h4 class="text-success mt-3">Ready for Orders!</h4>
                <p class="text-muted">Cashier will send orders here...</p>
            </div>
        `;
    }, 3000);

    // ... rest of your functions (addOrder, updateDisplay, etc.) stay the same
    function addOrder(order) {
        const items = typeof order.items === 'string' ? JSON.parse(order.items) : order.items;
        orders.unshift({...order, items: items, id: order.id || Date.now()});
        updateDisplay();
        updateCounts();
    }

    function updateOrderStatus(orderNumber, status) {
        const order = orders.find(o => o.orderNumber === orderNumber);
        if (order) {
            order.status = status;
            updateDisplay();
            updateCounts();
        }
    }

    function updateDisplay() {
        const container = document.getElementById('orders-container');
        if (orders.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center p-5">
                    <div class="display-4 text-muted">ğŸ‰</div>
                    <h4 class="text-muted mt-3">No orders yet!</h4>
                    <p class="text-muted">Ready for incoming orders...</p>
                </div>
            `;
            return;
        }
        // ... your existing updateDisplay code
    }

    function updateCounts() {
        orderCounts = orders.reduce((counts, order) => {
            counts[order.status]++;
            return counts;
        }, { pending: 0, preparing: 0, expected: 0 });
        
        document.getElementById('pending-count').textContent = orderCounts.pending;
        document.getElementById('preparing-count').textContent = orderCounts.preparing;
        document.getElementById('completed-count').textContent = orderCounts.completed;
    }

    function updateStatus(orderNumber, status) {
        console.log(`ğŸ”§ Updating ${orderNumber} to ${status}`);
        socket.emit('updateOrderStatus', { orderNumber, status });
    }
</script>

</body>
</html>
